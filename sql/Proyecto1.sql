CREATE TABLE USUARIO (
    ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY, 
    EMAIL VARCHAR2(100) NOT NULL UNIQUE, 
    CELULAR VARCHAR2(20), 
    CEDULA VARCHAR2(20) NOT NULL UNIQUE, 
    FECHA_REGISTRO DATE DEFAULT SYSDATE NOT NULL
);
CREATE TABLE USUARIO_CONDUCTOR (
    ID NUMBER PRIMARY KEY,
    ACTIVO NUMBER(1) DEFAULT 1 NOT NULL CHECK (ACTIVO IN (0, 1)), 
    CONSTRAINT FK_CONDUCTOR_USUARIO FOREIGN KEY (ID) REFERENCES USUARIO(ID)
);
CREATE TABLE USUARIO_SERVICIO (
    ID NUMBER PRIMARY KEY,
    TARJETA_NUMERO VARCHAR2(20), 
    TARJETA_NOMBRE VARCHAR2(100),
    TARJETA_VENCIMIENTO DATE, 
    TARJETA_CVV NUMBER(4),
    CONSTRAINT FK_USER_SERVICIO_USUARIO FOREIGN KEY(ID) REFERENCES USUARIO(ID)
);
CREATE TABLE PUNTO_GEOGRAFICO (
    ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    NOMBRE VARCHAR2(100),
    DIRECCION VARCHAR2(255) NOT NULL,
    LATITUD NUMBER(10, 7) NOT NULL, 
    LONGITUD NUMBER(10, 7) NOT NULL
);
CREATE TABLE VEHICULO (
    ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_USUARIO_CONDUCTOR NUMBER NOT NULL,
    TIPO VARCHAR2(20) NOT NULL CHECK(TIPO IN('CARRO','CAMIONETA','MOTOCICLETA')),
    MARCA VARCHAR2(50) NOT NULL,
    MODELO VARCHAR2(50) NOT NULL,
    COLOR VARCHAR2(30) NOT NULL,
    PLACA VARCHAR2(10) NOT NULL UNIQUE, 
    CIUDAD_EXPEDICION VARCHAR2(50) NOT NULL,
    CAPACIDAD_PASAJEROS NUMBER(2) NOT NULL,
    ACTIVO NUMBER(1) DEFAULT 1 NOT NULL CHECK (ACTIVO IN (0, 1)),
    NIVEL VARCHAR2(20) CHECK(NIVEL IN('ESTANDAR', 'COMFORT', 'LARGE')), 
    CONSTRAINT FK_VEHICULO_CONDUCTOR FOREIGN KEY (ID_USUARIO_CONDUCTOR) REFERENCES USUARIO_CONDUCTOR(ID)
);
CREATE TABLE CIUDAD (
    ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    NOMBRE VARCHAR2(100) NOT NULL UNIQUE
);
CREATE TABLE SERVICIOS (
  ID                NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  TIPO_SERVICIO     VARCHAR2(50)    NOT NULL,
  COSTO_TOTAL       NUMBER(10,2)    NOT NULL,
  HORA_INICIO       TIMESTAMP       NOT NULL,
  HORA_FIN          TIMESTAMP       NULL,
  DURACION_MINUTOS  NUMBER(10)      NULL,
  LONGITUD_TRAYECTO NUMBER(10,2)    NULL,
  ID_CONDUCTOR      NUMBER          NOT NULL,
  ID_USUARIO_CLIENTE NUMBER         NOT NULL,
  ID_VEHICULO       NUMBER          NOT NULL,
  ID_PUNTO_PARTIDA  NUMBER          NOT NULL,
  CONSTRAINT FK_SERV_COND     FOREIGN KEY (ID_CONDUCTOR)      REFERENCES USUARIO_CONDUCTOR(ID),
  CONSTRAINT FK_SERV_CLIENTE  FOREIGN KEY (ID_USUARIO_CLIENTE) REFERENCES USUARIO_SERVICIO(ID),
  CONSTRAINT FK_SERV_VEH      FOREIGN KEY (ID_VEHICULO)       REFERENCES VEHICULO(ID),
  CONSTRAINT FK_SERV_PPART    FOREIGN KEY (ID_PUNTO_PARTIDA)  REFERENCES PUNTO_GEOGRAFICO(ID)
);

CREATE TABLE VIAJE (
    ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_USUARIO_SERVICIO NUMBER NOT NULL,
    ID_USUARIO_CONDUCTOR NUMBER NOT NULL,
    ID_VEHICULO NUMBER, 
    ID_PUNTO_INICIO NUMBER NOT NULL,
    ID_PUNTO_FIN NUMBER NOT NULL,
    HORA_INICIO TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL, 
    HORA_FIN TIMESTAMP WITH TIME ZONE,
    DISTANCIA_KM NUMBER(10, 2), 
    COSTO_TOTAL NUMBER(10, 2), 
    CONSTRAINT FK_VIAJE_USUARIO_SERVICIO FOREIGN KEY (ID_USUARIO_SERVICIO) REFERENCES USUARIO_SERVICIO(ID),
    CONSTRAINT FK_VIAJE_USUARIO_CONDUCTOR FOREIGN KEY (ID_USUARIO_CONDUCTOR) REFERENCES USUARIO_CONDUCTOR(ID),
    CONSTRAINT FK_VIAJE_VEHICULO FOREIGN KEY (ID_VEHICULO) REFERENCES VEHICULO(ID),
    CONSTRAINT FK_VIAJE_PUNTO_INICIO FOREIGN KEY (ID_PUNTO_INICIO) REFERENCES PUNTO_GEOGRAFICO(ID),
    CONSTRAINT FK_VIAJE_PUNTO_FIN FOREIGN KEY (ID_PUNTO_FIN) REFERENCES PUNTO_GEOGRAFICO(ID)
);

CREATE TABLE SERVICIO_PUNTOS_LLEGADA (
  ID_SERVICIO        NUMBER NOT NULL,
  ID_PUNTO_GEOGRAFICO NUMBER NOT NULL,
  CONSTRAINT PK_SERV_PUNTOS PRIMARY KEY (ID_SERVICIO, ID_PUNTO_GEOGRAFICO),
  CONSTRAINT FK_SPL_SERV FOREIGN KEY (ID_SERVICIO) REFERENCES SERVICIOS(ID),
  CONSTRAINT FK_SPL_PG   FOREIGN KEY (ID_PUNTO_GEOGRAFICO) REFERENCES PUNTO_GEOGRAFICO(ID)
);


CREATE TABLE REVISIONES (
  ID           NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  ID_SERVICIO  NUMBER     NOT NULL UNIQUE,        -- una revisiÃ³n por servicio
  CALIFICACION NUMBER(1)  NOT NULL CHECK (CALIFICACION BETWEEN 0 AND 5),
  COMENTARIO   VARCHAR2(500),
  ID_REVISOR   NUMBER     NOT NULL,
  ID_REVISADO  NUMBER     NOT NULL,
  CONSTRAINT FK_REV_SERV     FOREIGN KEY (ID_SERVICIO) REFERENCES SERVICIOS(ID),
  CONSTRAINT FK_REV_REVISOR  FOREIGN KEY (ID_REVISOR)  REFERENCES USUARIO(ID),
  CONSTRAINT FK_REV_REVISADO FOREIGN KEY (ID_REVISADO) REFERENCES USUARIO(ID)
);

CREATE TABLE DISPONIBILIDADES (
  ID            NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  DIA_SEMANA    VARCHAR2(10) NOT NULL
                  CHECK (DIA_SEMANA IN ('MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY','SUNDAY')),
  HORA_INICIO   TIMESTAMP    NOT NULL,
  HORA_FIN      TIMESTAMP    NOT NULL,
  TIPO_SERVICIO VARCHAR2(50) NOT NULL,
  ID_VEHICULO   NUMBER       NOT NULL,
  CONSTRAINT CH_DISP_RANGO CHECK (HORA_FIN > HORA_INICIO),
  CONSTRAINT UQ_DISP UNIQUE (ID_VEHICULO, DIA_SEMANA, HORA_INICIO, HORA_FIN),
  CONSTRAINT FK_DISP_VEH FOREIGN KEY (ID_VEHICULO) REFERENCES VEHICULO(ID)
);